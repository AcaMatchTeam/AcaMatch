<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.green.acamatch.academy.mapper.AcademyMapper">


<!--태그 select-->
    <select id="selTagDtoList">
        SELECT tag_id as tagId,tag_name as tagName
        FROM tag
        <where>
            <if test="searchTag != null and searchTag != ''">
                tag_name LIKE CONCAT('%', #{searchTag}, '%')
            </if>
        </where>
    </select>


<!--태그 학원등록-->
    <insert id="insAcaTag">
        INSERT INTO academytag (aca_id, tag_id)
        VALUES
        <foreach collection="tagIdList" item="tagId" separator=",">
            (#{acaId}, #{tagId})
        </foreach>
    </insert>


<!--학원정보등록-->
    <insert id="insAcademy" useGeneratedKeys="true" keyProperty="acaId">
        INSERT INTO academy
           SET user_id = #{userId}
             , dong_id = #{dongId}
             , aca_name = #{acaName}
             , aca_phone = #{acaPhone}
             , comment = #{comment}
             , teacher_num = #{teacherNum}
             , open_time = #{openTime}
             , close_time = #{closeTime}
             , address = #{address}
             , aca_pic = #{acaPic}
    </insert>


<!--학원정보수정-->
    <update id="updAcademy">
        UPDATE academy
        <set>
            <if test="acaName != null and acaName != ''">
                aca_name = #{acaName}
            </if>
            <if test="acaPhone != null and acaPhone != ''">
                , aca_phone = #{acaPhone}
            </if>
            <if test="comment != null and comment != ''">
                , comment = #{comment}
            </if>
            <if test="teacherNum != null and teacherNum != ''">
                , teacher_num = #{teacherNum}
            </if>
            <if test="openTime != null and openTime != ''">
                , open_time = #{openTime}
            </if>
            <if test="closeTime != null and closeTime != ''">
                , close_time = #{closeTime}
            </if>
            <if test="acaPic != null and acaPic != ''">
                , aca_pic = #{acaPic}
            </if>
            <if test="address != null and address != ''">
                , address = #{address}
            </if>
        </set>
        WHERE aca_id = #{acaId}
        AND user_id = #{userId}
    </update>

<!--학원정보수정에서 태그수정을 위한 삭제처리-->
    <delete id="delAcaTag">
        DELETE FROM academytag
        WHERE aca_id = #{acaId}
    </delete>


<!--학원정보삭제-->
    <delete id="delAcademy">
        DELETE FROM academy
         WHERE aca_id = #{acaId}
           AND user_id = #{userId}
    </delete>

<!--학원 좋아요 순-->
    <select id="getAcademyBest" resultType="com.green.acamatch.academy.model.AcademyBestLikeGetRes">
        SELECT aca_id AS acaId, COUNT(aca_id) AS likeCount
          FROM `like`
         GROUP BY aca_id
         ORDER BY likeCount DESC
         LIMIT #{startIdx}, #{size}
    </select>

    <!-- 학원 검색 -->

    <resultMap id="searchResultMap" type = "com.green.acamatch.academy.model.getAcademyRes">
        <id property="acaId" column="acaId" />
        <result property="acaPic" column="acaPic" />
        <result property="acaName" column="acaName" />
        <result property="address" column="address" />
        <result property="star" column="star" />
        <collection property="tagName" resultMap="getTagDtoResultMap" />
    </resultMap>

    <resultMap id="getTagDtoResultMap" type="com.green.studybridge.academy.model.getAcademyTagDto">
        <id property="tagId" column="tagId" />
        <result property="tagName" column="tagName" />
    </resultMap>

    <select id="getAcademy" resultMap="searchResultMap">
        SELECT A.aca_id AS acaId, A.aca_name AS acaName, A.aca_pic AS acaPic, A.address,  F.tag_name AS tagName
        ,F.tag_id AS tagId , F.`tag_name` AS tagName, G.star
        FROM academy A
        JOIN class B
        ON A.aca_id = B.aca_id
        JOIN joinclass C
        ON B.class_id = C.class_id
        JOIN academytag E
        ON A.aca_id = E.aca_id
        JOIN tag F
        ON E.tag_id = F.tag_id
        join (select round(avg(star), 2) as star, join_class_id from review group by join_class_id) G
        on C.join_class_id = G.join_class_id
        WHERE A.dong_id = 778
        AND F.tag_name like concat ('%', #{tagName}, '%')
    </select>
    <select id="getAcademyDetail">
        SELECT A.aca_id, A.aca_phone, A.aca_name, A.aca_pic, A.COMMENT, A.teacher_num, A.open_time, A.close_time, address
        FROM academy A
        WHERE aca_id = #{acaId}
    </select>
    <select id="getTagList">
        select tag_name AS tagName
        from tag
    </select>



</mapper>
